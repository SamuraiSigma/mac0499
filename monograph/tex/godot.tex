\chapter{Godot}
\label{cap:godot}

Voltaremos nossa atenção à \textit{game engine} \textit{Godot} neste capítulo. Em particular, estamos interessados no estudo dos elementos principais que compõe sua arquitetura, a organização do seu código fonte e instruções para compilação.

Para referência, todas as informações relacionadas a \textit{Godot} são referentes à versão \textbf{2.1.4}, que é a mais recente e estável no momento de escrita deste trabalho.

Todas as instruções e comandos apresentados foram originalmente realizados no sistema \texttt{Ubuntu 16.04 LTS, 64-bit} do autor.

% ---------------------------------------------------------------------

\section{História}

O desenvolvimento de \textit{Godot} começou em 2007, através de Juan Linietsky e Ariel Manzur. O nome foi escolhido em homenagem à peça \emph{Waiting for Godot}, de Samuel Beckett, para representar uma biblioteca que cada vez mais ganha novas funcionalidades, mas nunca chegará a um produto definitivo \citep{godotHistory}.

\textit{Godot} é notavelmente conhecido por possuir código aberto, que foi liberado ao público em fevereiro de 2014. Desde então, ganha constantes atualizações para se equiparar a \textit{game engines} competidoras mais sofisticadas, como \textit{Unity} e \textit{Unreal Engine}. Atualmente, encontra-se na versão 2.1.4, com uma versão 3 em beta.

% ---------------------------------------------------------------------

\section{Linguagens}

\textit{Godot} possui seu código fonte escrito primordialmente em \textbf{\textit{C++}}. Apesar de não possuir toda a versatilidade de uma linguagem de \textit{script} como \textit{Python} e \textit{Ruby}, um código escrito em \textit{C++} possui uma execução bem rápida, fator crítico para um software que produzirá jogos. Comparado ao antecessor, \textit{C}, a linguagem oferece ferramentas mais poderosas, como Orientação a Objetos e bibliotecas para tipos abstratos de dados (pilhas, filas, etc.).

Um usuário da \textit{game engine}, no entanto, raramente interage diretamente com \textit{C++}, utilizando-se ao invés disso uma linguagem de \textit{script} nativa ao \textit{Godot} chamada \mbox{\textbf{\textit{GDScript}}}. Por ter uma sintaxe extremamente simples, parecida com \textit{Python}, e ter sido projetada para usufruir da arquitetura da \textit{game engine}, o usuário pode programar classes, estruturas e partes de seu jogo com maior facilidade, utilizando as ferramentas oferecidas pelo software sem precisar se preocupar com detalhes maiores de implementação \citep{godotGDScript}. Em outras palavras, \mbox{\textit{GDScript}} age como uma ``linguagem intermediária'' entre o usuário e as interfaces em \textit{C++} que \textit{Godot} disponibiliza.

% ---------------------------------------------------------------------

\section{Arquitetura}

% ---------------------------------------------------------------------

\subsection{\textit{Node}}

Um \textbf{\textit{node}} (nó) é um dos elementos mais básicos para a criação de jogos em \textit{Godot}. Todo \textit{node} possui um nome, propriedades (que podem ser alteradas/sobrescritas) e um \emph{comportamento}: desenhar um modelo em 3D, mostrar uma interface gráfica, controlar o comportamento de um personagem, etc. \citep{godotNode}.

\textit{Nodes} oferecem a opção de extendê-los, criando um novo tipo de nó com funções adicionais; esta funcionalidade é idêntica à ideia de herança entre classes em Programação Orientada a Objetos.

A propriedade mais importante que oferecem é a adição a outros \textit{nodes}, tornando-se filho deles. Com isso, cria-se uma hierarquia de árvore, deixando claro a dependência de funcionalidades.

Como exemplos, apresentamos a seguir alguns tipos de nós, citando em alguns casos a relação com o código \textit{C++} da \textit{game engine}.

\begin{itemize}
\item \textbf{\textit{BaseButton}}: Oferece funcionalidades básicas a todos os nós do tipo \textit{button} (botões). Internamente (em \textit{C++}), é implementado como uma classe abstrata.

\item \textbf{\textit{Button}}: É um botão padrão, que pode ser clicado pelo usuário. Estende o nó \textit{BaseButton} (na implementação em \textit{C++}, é uma classe que herda de \textit{BaseButton}).

\item \textbf{\textit{Label}}: Apresenta um texto formatado.
\end{itemize}

Suponha que desejamos criar um botão clicável, onde está escrito \textit{``Começar Jogo''}. Ao pensarmos que este botão deverá \emph{conter} um texto, a hierarquia de \textit{nodes} fica intuitiva: iremos criar um nó \textit{Button} que possui um filho \textit{Label}. Além disso, desejamos alterar a propriedade de texto deste último para o valor \textit{``Começar Jogo''}.

Teremos uma visão mais prática de nós na seção \ref{cap:color-clutter}, onde criaremos um jogo em \textit{Godot}.

% ---------------------------------------------------------------------

\subsection{\textit{Scene}}

Uma \textbf{\textit{scene}} (cena) é um grupo de \textit{nodes} organizados em uma hierarquia de árvore. Toda cena possui apenas um nó raiz \citep{godotScene}.

Em \textit{Godot}, executar um jogo é equivalente a executar uma ou mais cenas, que podem ser salvas ou carregadas do disco no decorrer do programa. Ressalta-se que, para o jogo começar, uma \textit{scene} deve ser previamente configurada como a inicial, isto é, a primeira a ser executada quando o jogo é iniciado.

A maior vantagem de um \textit{scene}, portanto, está em sua modularização. Ao invés de se criar um jogo grande com uma quantidade enorme de nós em hierarquia, podem-se fazer várias cenas, com uma \emph{instanciando} outra durante a execução. Tal instância é adicionada na árvore da \textit{scene} que fez a chamada. Quando a cena não é mais necessária, ela pode ser salva no disco, se necessário, e retirada da hierarquia.

% TODO: Colocar alguma imagem de instanciamento

% ---------------------------------------------------------------------

\subsection{\textit{Resource}}

\textbf{\textit{Resources}} (recursos) são outro tipo de dados em \textit{Godot} com uma importância tão grande quanto \textit{nodes}. Todo recurso armazena algum dado, e portanto não realizam uma ação ou processamento por si só \citep{godotResource}.

Uma característica importante de \textit{resources} é que são carregados apenas uma vez do disco. Se um recurso que já está na memória for novamente carregado, será retornado a mesma cópia de antes; em detalhes internos, \textit{Godot} guarda uma referência ao \textit{resource} original.

A classe \textit{Resource} herda, no código C++, de \textit{Reference} (referência). Esta classe e seus filhos possuem uma propriedade especial: a \textit{game engine} se encarrega de automaticamente liberar sua memória alocada quando não são mais referenciadas por nenhuma outra estrutura, trazendo uma característica de \emph{coleta de lixo} ao sistema.

Exemplos de \textit{resources} incluem:

\begin{itemize}
\item \textbf{\textit{Texture}}: Representa uma textura a ser aplicada em um objeto 2D ou 3D.

\item \textbf{\textit{Font}}: Representa uma fonte a ser usada em um texto, interface gráfica, etc.

\item \textbf{\textit{AudioStream}}: Usado para guardar um fluxo de áudio (uma música a ser tocada no jogo, por exemplo).
\end{itemize}

% ---------------------------------------------------------------------

\section{\textit{SCons}}

\textit{Godot} pode ser compilado para diversas plataformas; entre elas, citamos Windows, MacOS, Unix, Android, iOS e HTML5. A necessidade de atender a uma variedade tão grande de sistemas operacionais fez com que o projeto escolhesse \textbf{\textit{SCcons}} para simplificar sua compilação \citep{godotScons}. Esta é uma ferramenta de construção de código aberto, como \textit{automake} e \textit{cmake}, mas apresenta algumas vantagens interessantes \citep{scons}:

\begin{itemize}
\item Compilação multiplataforma. Por exemplo, é possível compilar um executável para Windows em um sistema Unix.

\item Todos os arquivos de configuração são \textit{scripts} na linguagem \textit{Python}.

\item Análise de dependências automática para linguagens como \textit{C}, \textit{C++} e \textit{Java}. Não é necessário, por exemplo, listar quais arquivos de código fonte são necessários para compilar o binário final, algo que ocorre em um sistema \textit{Make}.
\end{itemize}

% ---------------------------------------------------------------------

\subsection{Instalação}

\textit{SCons} pode ser instalado pela linha de comando. Em um ambiente Ubuntu, por exemplo, digitaria-se:

\begin{lstlisting}[language=Bash]
$ sudo apt-get install scons
\end{lstlisting}

Também é possível baixar um binário ou o código fonte pelo site \citep{sconsDownload}.

% ---------------------------------------------------------------------

\subsection{Uso em \textit{Godot}}

Para usar o SCons com os \textit{scripts} de configuração em um diretório, basta invocá-lo:

\begin{lstlisting}[language=Bash]
$ scons
\end{lstlisting}

\textit{Godot} oferece alguns argumentos por linha de comando para maior controle sobre a compilação, que usaremos na seção \ref{godotCompile} e no capítulo \ref{cap:color-clutter}. Veja a tabela \ref{sconsParams} para maiores informações.

\begin{table}[H]

\centering
\begin{tabular}{|c|C{.35\textwidth}|L{.4\textwidth}|}
\hline
\textbf{Parâmetro} & \textbf{Significado} & \thead{\textbf{Valores}} \\ \hline

\texttt{p, platform} & Plataforma alvo da compilação &
\makecell[l]{
  Inclui: \\
  \begin{tabular}{@{}ll@{}}
    \texttt{x11} (Unix) & \texttt{javascript} (Web) \\
    \texttt{windows} & \texttt{android} \\
    \texttt{osx} & \texttt{iphone} \\
  \end{tabular}
} \\ \hline

\texttt{bits} & Nº de bits da plataforma alvo &
\makecell[l]{
  \texttt{32} \\
  \texttt{64} \\
  \texttt{default}
} \\ \hline

\texttt{tools} & Deve-se incluir o editor \textit{Godot} no binário? &
\makecell[l]{
  \texttt{yes} \\
  \texttt{no}
} \\ \hline

\texttt{target} & Controla opções de otimização e \textit{debug} &
\makecell[l]{
  \texttt{debug} \\
  \texttt{release\_debug} \\
  \texttt{release}
} \\ \hline

\texttt{j} & Nº de processadores usados para compilação em paralelo &
Um inteiro compatível com o nº de processadores na máquina \\ \hline
\end{tabular}
\caption{Argumentos por linha de comando do \textit{SCons} para \textit{Godot}}
\label{sconsParams}
\end{table}

% ---------------------------------------------------------------------

\section{Compilação}
\label{godotCompile}

O código fonte de \textit{Godot} está disponível no \textit{GitHub} \citep{godotRepo}. A criação de um módulo, conforme será visto no capítulo \ref{cap:stt-module}, exige a adição de código à \textit{game engine} e sua recompilação, o que justifica a importância dos passos a seguir.
